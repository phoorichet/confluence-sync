# User Story: Add Read-Only YAML Metadata Frontmatter to Markdown Files

## Story Title
**Add YAML Metadata Frontmatter to Local Markdown - Brownfield Addition**

## User Story
**As a** confluence-sync user,  
**I want** to see Confluence page metadata directly in my local markdown files when I pull content,  
**So that** I can understand page context (author, dates, version) without switching to the manifest file.

## Story Context

**Existing System Integration:**
- Integrates with: Converter Module (src/converters/), Storage Manager (src/storage/), Sync Engine pull/push commands
- Technology: TypeScript, Bun runtime, YAML parsing libraries
- Follows pattern: Existing converter pattern for Confluence Storage Format ↔ Markdown transformation
- Touch points: 
  - Pull command: After converting Confluence to Markdown
  - Push command: Before converting Markdown to Confluence

## Acceptance Criteria

**Functional Requirements:**

1. When pull command fetches content from Confluence, YAML frontmatter with metadata is added to the top of each markdown file
2. Frontmatter includes: pageId, title, spaceKey, author, createdDate, lastModified, version, parentId
3. Frontmatter contains clear "READ-ONLY - DO NOT EDIT" warning comment
4. Push command strips all frontmatter before converting markdown back to Confluence format
5. All markdown files MUST have frontmatter after pull operation

**Integration Requirements:**

6. New functionality follows existing Converter Module pattern
7. Integration with Storage Manager maintains current behavior
8. Metadata in .confluence-sync.json manifest remains the authoritative source

**Quality Requirements:**

9. Change is covered by unit tests for frontmatter injection and stripping
10. Integration tests verify end-to-end metadata handling
11. TypeScript strict mode compliance maintained

## Technical Notes

- **Integration Approach:** 
  - Extend Converter Module's `confluenceToMarkdown()` method to append YAML frontmatter
  - Extend Converter Module's `markdownToConfluence()` method to strip frontmatter before conversion
  - Use existing metadata from manifest during pull operation

- **Existing Pattern Reference:** 
  - Follow converter pattern in `src/converters/markdown-converter.ts` (if exists)
  - Use Node.js imports: `import { parse, stringify } from 'node:yaml'` or similar YAML library

- **Key Constraints:** 
  - Frontmatter must use standard triple-dash format for markdown compatibility
  - Local edits to frontmatter must not propagate to server
  - All files must have frontmatter (no legacy support needed)

## Implementation Tasks

- [ ] **Task 1: Add YAML frontmatter injection** (AC: 1, 2, 3, 5)
  - [ ] Install YAML parsing library (e.g., js-yaml) if not present
  - [ ] Modify Converter Module's `confluenceToMarkdown()` method
  - [ ] Extract metadata from manifest during pull
  - [ ] Format metadata as YAML with READ-ONLY comment
  - [ ] Prepend frontmatter to markdown content

- [ ] **Task 2: Add frontmatter stripping for push** (AC: 4)
  - [ ] Modify Converter Module's `markdownToConfluence()` method
  - [ ] Detect and remove YAML frontmatter (between --- markers)
  - [ ] Ensure clean markdown is passed to Confluence conversion

- [ ] **Task 3: Ensure consistent behavior** (AC: 6, 7, 8)
  - [ ] Verify manifest remains source of truth
  - [ ] Ensure Storage Manager integration unchanged
  - [ ] Confirm all files get frontmatter on pull

- [ ] **Task 4: Add comprehensive testing** (AC: 9, 10, 11)
  - [ ] Write unit tests for frontmatter injection
  - [ ] Write unit tests for frontmatter stripping
  - [ ] Add integration test for full pull-edit-push cycle
  - [ ] Verify TypeScript strict compliance

## Definition of Done

- ✅ Functional requirements met (AC 1-5)
- ✅ Integration requirements verified (AC 6-8)
- ✅ Code follows existing patterns and TypeScript strict standards
- ✅ All tests pass (new tests added)
- ✅ Build succeeds with `bun run build`
- ✅ Linting passes with `bun run lint`

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Users edit frontmatter expecting sync
- **Mitigation:** Clear READ-ONLY comment in frontmatter
- **Rollback:** Remove frontmatter parsing logic if issues arise

**Compatibility Verification:**
- ✅ No breaking changes to existing APIs
- ✅ No database changes required
- ✅ UI (CLI output) remains unchanged
- ✅ Performance impact negligible (small string operations)

## Example Implementation

**YAML Frontmatter Format:**
```yaml
---
# READ-ONLY - DO NOT EDIT - Changes will not sync to Confluence
pageId: "12345678"
title: "Page Title"
spaceKey: "PROJ"
author: "john.doe"
createdDate: "2024-01-15T10:30:00Z"
lastModified: "2024-01-20T14:45:00Z"
version: 3
parentId: "87654321"
---

# Original Markdown Content
```

## Epic Reference

This story is part of the **Display Confluence Page Metadata in Local Markdown** brownfield epic.

**Epic Goal:** Enhance the pull command to embed read-only Confluence page metadata in markdown files as YAML frontmatter, allowing users to view page context (author, dates, version) directly in their local files while preserving metadata integrity during sync operations.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Sarah (PO) |