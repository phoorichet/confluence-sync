# Story 2.1: Enhanced Manifest & Change Detection

## Status
Draft

## Story
**As a** developer,
**I want** the system to track file states and detect changes,
**so that** sync operations can be intelligent and efficient.

## Acceptance Criteria
1. Manifest schema enhanced with file hashes, timestamps, and sync states
2. Local file change detection using content hashing (MD5 or SHA-256)
3. Remote change detection via Confluence version API comparison
4. Three-way state tracking: local changes, remote changes, or both changed
5. `confluence-sync status` command shows changed files and their states
6. Manifest supports multiple pages with hierarchical structure
7. Automatic manifest migration from v1 to v2 format

## Tasks / Subtasks
- [ ] Enhance manifest schema (AC: 1, 6)
  - [ ] Update SyncManifest interface in src/storage/manifest-manager.ts to include new fields
  - [ ] Add syncMode, config, and operation tracking fields
  - [ ] Update Page interface to include hierarchy support (parentId, children references)
  - [ ] Create zod schemas for validation using existing pattern
- [ ] Implement content hashing utilities (AC: 2)
  - [ ] Create src/utils/hash.ts with SHA-256 hashing functions
  - [ ] Add calculateFileHash(filePath) method
  - [ ] Add calculateStringHash(content) method
  - [ ] Export hash utilities for use in change detection
- [ ] Create change detection module (AC: 2, 3, 4)
  - [ ] Create src/sync/change-detector.ts implementing ChangeDetector class
  - [ ] Implement detectLocalChanges() to compare file hash with manifest
  - [ ] Implement detectRemoteChanges() to compare version numbers
  - [ ] Implement getChangeState() returning 'local-only' | 'remote-only' | 'both-changed' | 'unchanged'
  - [ ] Add batch change detection for multiple files
- [ ] Implement status command (AC: 5)
  - [ ] Create src/commands/status.ts implementing Commander command
  - [ ] Register status command in src/cli.ts
  - [ ] Display table showing: file path, local state, remote state, conflict status
  - [ ] Use chalk for color coding: green (synced), yellow (changed), red (conflicted)
  - [ ] Add --json flag for machine-readable output
- [ ] Update ManifestManager for v2 format (AC: 1, 6, 7)
  - [ ] Enhance load() method to detect manifest version
  - [ ] Implement migrateV1ToV2() for automatic migration
  - [ ] Update save() method to preserve new fields
  - [ ] Add methods: getAllPages(), getPagesBySpace(), getPageHierarchy()
  - [ ] Ensure backward compatibility during migration
- [ ] Create comprehensive tests
  - [ ] Unit tests in tests/unit/sync/change-detector.test.ts
  - [ ] Unit tests in tests/unit/utils/hash.test.ts
  - [ ] Unit tests for manifest migration in tests/unit/storage/manifest-manager.test.ts
  - [ ] Integration test in tests/integration/sync/status.test.ts
  - [ ] Test edge cases: empty files, large files, binary content
  - [ ] Test manifest migration scenarios

## Dev Notes

### Previous Story Insights
From Story 1.5 completion:
- ManifestManager already exists with basic Page tracking using Map<string, Page>
- Tests should use spyOn() instead of vi.mock() due to Bun runtime limitations
- File paths must always use path.resolve() for absolute paths
- Error codes (CS-XXX) pattern established for consistent error handling

### Data Models
[Source: architecture/data-models.md#Page]
The Page model already includes:
- `id`: string - Unique Confluence page ID
- `spaceKey`: string - Confluence space identifier
- `title`: string - Page title
- `version`: number - Confluence version number
- `parentId`: string | null - Parent page ID for hierarchy (already exists!)
- `lastModified`: Date - Confluence last modification timestamp
- `localPath`: string - Relative path to local Markdown file
- `contentHash`: string - SHA-256 hash of content for change detection (already exists!)
- `status`: 'synced' | 'modified' | 'conflicted' - Current sync status (already exists!)

[Source: architecture/data-models.md#SyncManifest]
SyncManifest needs enhancement with:
- `version`: string - Manifest schema version for migrations
- `confluenceUrl`: string - Base URL of Confluence instance (already exists!)
- `lastSyncTime`: Date - Timestamp of last successful sync (already exists!)
- `syncMode`: 'manual' | 'watch' - Current operation mode (NEW)
- `pages`: Map<string, Page> - Indexed collection of tracked pages (already exists!)
- `config`: SyncConfig - User preferences and settings (NEW)

[Source: architecture/data-models.md#SyncOperation]
New SyncOperation model for tracking:
- `id`: string - Unique operation identifier (UUID)
- `type`: 'pull' | 'push' | 'sync' - Operation type
- `pageIds`: string[] - Pages involved in operation
- `startTime`: Date - Operation start timestamp
- `endTime`: Date | null - Operation completion timestamp
- `status`: 'pending' | 'in-progress' | 'completed' | 'failed'
- `changes`: ChangeSet[] - List of changes in this operation
- `error`: Error | null - Error details if failed

### Project Structure
[Source: architecture/source-tree.md]
New files to create:
- `src/sync/change-detector.ts` - Change detection logic
- `src/utils/hash.ts` - Content hashing utilities
- `src/commands/status.ts` - Status command implementation

Existing files to modify:
- `src/storage/manifest-manager.ts` - Already exists, needs enhancement
- `src/cli.ts` - Add status command registration

### Libraries and Dependencies
[Source: architecture/tech-stack.md#Technology Stack Table]
- **Hashing**: Use Node.js built-in crypto module (already available in Bun)
- **Validation**: zod 3.22.0 - Runtime validation (already in project)
- **Terminal Output**: chalk 5.3.0 - Colored terminal output (already in project)
- **Progress**: ora 8.0.0 - Loading spinners (already in project)

### Technical Implementation Notes
- Use SHA-256 for content hashing (more secure than MD5)
- ManifestManager is already a singleton pattern - maintain this
- Follow existing error code pattern: CS-XXX
- All file operations must use absolute paths via path.resolve()
- Never use console.log - use logger utility

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- Unit tests location: tests/unit/sync/ and tests/unit/utils/
- Use Vitest 1.2.0 framework
- Mock external dependencies
- Follow AAA pattern (Arrange, Act, Assert)
- Coverage requirement: 80% for sync/ modules

## Testing

### Testing Standards
- Test file location: tests/unit/sync/change-detector.test.ts, tests/unit/utils/hash.test.ts
- Use Vitest 1.2.0 with spyOn() for mocking (not vi.mock())
- Coverage requirement: 80% for sync/ modules
- Follow AAA pattern for test structure
- Mock file system operations and API calls
- Test edge cases: empty files, missing files, permission errors

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results